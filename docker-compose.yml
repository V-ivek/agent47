services:
  redpanda:
    image: redpandadata/redpanda:v24.1.1
    command:
      - redpanda start
      - --smp=1
      - --memory=256M
      - --overprovisioned
      - --node-id=0
      - --kafka-addr internal://0.0.0.0:29092,external://0.0.0.0:9093
      - --advertise-kafka-addr internal://redpanda:29092,external://localhost:9093
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:9094
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:9094
    ports:
      - "9093:9093"
      - "9094:9094"
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -q 'Healthy:.*true'"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: clawderpunk
      POSTGRES_PASSWORD: clawderpunk
      POSTGRES_DB: clawderpunk
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clawderpunk"]
      interval: 3s
      timeout: 3s
      retries: 10
    volumes:
      - pgdata:/var/lib/postgresql/data

  clawderpunk-records:
    build: .
    ports:
      - "8000:8000"
    environment:
      KAFKA_BROKERS: redpanda:29092
      KAFKA_TOPIC: clawderpunk.events.v1
      KAFKA_CONSUMER_GROUP: punk-records
      DATABASE_URL: postgresql://clawderpunk:clawderpunk@postgres:5432/clawderpunk
      PUNK_RECORDS_API_TOKEN: test-token-123
      LOG_LEVEL: INFO
    depends_on:
      redpanda:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\""]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

volumes:
  pgdata:
